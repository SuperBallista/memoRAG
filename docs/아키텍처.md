# memoRAG 시스템 아키텍처 문서

## 1. 시스템 개요

memoRAG는 교사용 문서 검색 및 질의응답 지원 시스템으로, RAG(Retrieval-Augmented Generation) 기술을 활용하여 로컬 환경에서 안전하게 동작하는 CLI 기반 애플리케이션입니다.

### 핵심 설계 원칙
- **로컬 우선**: 모든 데이터 처리는 로컬에서만 수행 (보안)
- **경량화**: CLI 기반으로 빠르고 가벼운 실행
- **확장성**: 향후 GUI, WebUI, LLM 연동 확장 가능한 구조
- **간편 배포**: PyInstaller를 통한 단일 실행 파일 배포

---

## 2. 시스템 아키텍처

```
┌─────────────────────────────────────────────────────────────┐
│                        사용자 Layer                          │
│   (교사 개인 / 학년부·교무부)                                 │
└──────────────────────┬──────────────────────────────────────┘
                       │ CLI Commands
                       ↓
┌─────────────────────────────────────────────────────────────┐
│                   Application Layer                          │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐      │
│  │  Query       │  │  Indexing    │  │  Management  │      │
│  │  Handler     │  │  Service     │  │  Service     │      │
│  └──────────────┘  └──────────────┘  └──────────────┘      │
└──────────────┬───────────────┬───────────────┬──────────────┘
               │               │               │
               ↓               ↓               ↓
┌─────────────────────────────────────────────────────────────┐
│                     Core Layer                               │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐      │
│  │  Embedding   │  │  Document    │  │  Vector      │      │
│  │  Engine      │  │  Parser      │  │  Search      │      │
│  └──────────────┘  └──────────────┘  └──────────────┘      │
└──────────────┬───────────────┬───────────────┬──────────────┘
               │               │               │
               ↓               ↓               ↓
┌─────────────────────────────────────────────────────────────┐
│                   Storage Layer                              │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐      │
│  │  ChromaDB    │  │  로컬 문서   │  │  메타데이터  │      │
│  │  (Vector DB) │  │  파일 시스템 │  │  캐시        │      │
│  └──────────────┘  └──────────────┘  └──────────────┘      │
└─────────────────────────────────────────────────────────────┘
```

---

## 3. 주요 컴포넌트 상세

### 3.1 Application Layer

#### Query Handler
- **역할**: 사용자의 자연어 질의를 처리하고 답변 반환
- **주요 기능**:
  - 자연어 질의 전처리
  - 벡터 검색 결과 후처리
  - 응답 포맷팅 (문서 경로, 페이지, 스니펫)

#### Indexing Service
- **역할**: 문서 폴더를 스캔하여 벡터 DB에 인덱싱
- **주요 기능**:
  - 폴더 트리 탐색
  - 문서 파일 감지 및 변경사항 추적
  - 청크 단위 분할 및 임베딩 생성
  - 메타데이터 추출 (파일명, 경로, 수정일)

#### Management Service
- **역할**: 시스템 관리 및 유지보수
- **주요 기능**:
  - 인덱스 초기화/삭제
  - 캐시 관리
  - 통계 정보 조회

### 3.2 Core Layer

#### Embedding Engine
- **모델**: `intfloat/multilingual-e5-base`
- **특징**: 한국어/영어 다국어 지원, 384차원 벡터
- **역할**: 텍스트를 벡터로 변환
- **최적화**: 배치 처리, 캐싱

#### Document Parser
- **지원 포맷**:
  - PDF: `pypdf` 라이브러리
  - DOCX: `python-docx` 라이브러리
  - HWPX: `lxml` (zip + XML 파싱)
  - TXT, MD: 내장 처리
- **역할**: 다양한 문서 포맷을 텍스트로 추출
- **기능**:
  - 문서 구조 분석 (제목, 본문, 표)
  - 페이지/섹션 메타데이터 추출
  - 인코딩 자동 감지

#### Vector Search
- **역할**: 쿼리 벡터와 유사한 문서 청크 검색
- **기능**:
  - 코사인 유사도 기반 검색
  - Top-K 결과 반환
  - 메타데이터 필터링 (폴더, 날짜, 파일 타입)

### 3.3 Storage Layer

#### ChromaDB (Vector DB)
- **저장 위치**: `./chroma/` (로컬)
- **저장 데이터**:
  - 문서 청크 벡터 (임베딩)
  - 원본 텍스트 스니펫
  - 메타데이터 (파일 경로, 페이지, 타임스탬프)
- **특징**: 
  - 로컬 파일 기반, 빠른 검색
  - 인덱스 영구 저장 및 증분 업데이트
  - **단일 파일/폴더로 패키징 가능** (부서 모드 공유용)
- **부서 모드 활용**:
  - 인덱스를 독립적인 DB 파일로 생성 가능
  - 예: `5학년부_2025.db`, `교무부_공지.db`
  - 원본 문서 없이 인덱스 파일만으로 검색 가능
  - **업무 메신저로 간편하게 공유 및 배포**

#### 로컬 문서 파일 시스템
- **역할**: 원본 문서 저장소
- **지원**: 개인 폴더 / 부서 공유 폴더

#### 메타데이터 캐시
- **역할**: 인덱싱된 파일 정보 추적
- **내용**: 파일 경로, 수정일, 해시값
- **목적**: 중복 인덱싱 방지, 증분 업데이트

---

## 4. 데이터 흐름

### 4.1 문서 인덱싱 흐름

```
1. 사용자 입력
   └─> CLI: rag_local.exe index --folder ./documents

2. Indexing Service
   └─> 폴더 스캔 → 신규/변경 파일 감지

3. Document Parser
   └─> 파일 타입별 파싱 → 텍스트 추출

4. Chunking
   └─> 텍스트를 의미 단위(512토큰)로 분할

5. Embedding Engine
   └─> 각 청크를 벡터로 변환

6. ChromaDB
   └─> 벡터 + 메타데이터 저장

7. 캐시 업데이트
   └─> 인덱싱 완료 파일 기록
```

### 4.2 검색/질의 응답 흐름

```
1. 사용자 입력
   └─> CLI: rag_local.exe query "5학년 수련활동 일정"

2. Query Handler
   └─> 자연어 질의 전처리

3. Embedding Engine
   └─> 질의를 벡터로 변환

4. Vector Search (ChromaDB)
   └─> 코사인 유사도 Top-K 검색

5. 후처리
   └─> 결과 랭킹, 스니펫 추출

6. 응답 포맷팅
   └─> 출력: 문서 경로 + 페이지 + 스니펫 내용

7. 사용자에게 반환
```

---

## 5. 기술 스택

| 계층 | 기술 | 용도 |
|------|------|------|
| **언어** | Python 3.9+ | 메인 개발 언어 |
| **CLI** | argparse / click | 커맨드 라인 인터페이스 |
| **임베딩** | sentence-transformers | multilingual-e5-base 모델 |
| **벡터 DB** | ChromaDB | 로컬 벡터 저장 및 검색, **독립 DB 파일 생성 가능** |
| **문서 파싱** | pypdf, python-docx, lxml | 다양한 포맷 지원 |
| **배포** | PyInstaller | 단일 exe 파일 생성 |

---

## 6. 보안 설계

### 6.1 로컬 처리 원칙
- 모든 데이터는 로컬 PC에서만 처리
- 외부 서버 업로드 없음
- 인터넷 연결 불필요 (모델 다운로드 후)

### 6.2 데이터 보호
- 인덱스 데이터: `./chroma/` 폴더에 격리 저장
- 캐시 삭제: `--clean` 옵션으로 전체 데이터 삭제 가능
- 원본 문서는 읽기 전용 접근

### 6.3 권한 관리
- 개인 모드: 사용자 PC 내 개인 문서만 접근
- 부서 모드: 공유 폴더 경로 명시적 지정 필요

### 6.4 부서 모드 인덱스 파일 공유 전략 ⭐

#### 핵심 개념
부서 모드에서는 **인덱스 데이터 파일 자체를 팀원들에게 공유**하는 방식을 채택합니다. 이는 다음과 같은 장점을 제공합니다:

#### 장점
1. **간편한 배포**: 원본 문서 폴더 전체가 아닌, 단일 인덱스 파일(또는 폴더)만 공유
2. **빠른 업무 조회**: 팀원은 인덱스 파일만 다운받으면 즉시 검색 가능 (원본 파일 불필요)
3. **직관적인 보안**: 
   - 파일 단위로 공유/삭제 관리
   - "5학년부_2025.db" 삭제하면 모든 데이터 제거
   - 업무 메신저(카카오톡 워크, 슬랙 등)로 파일 전송 가능
4. **버전 관리**: 날짜별/주제별로 인덱스 파일 분리 가능
   - `교무부_공지사항_2025_09.db`
   - `5학년_수련활동_최종본.db`

#### 운영 방식
```
[부서 담당자]
1. 원본 문서 폴더를 인덱싱
   └─> rag_local.exe index --folder ./5학년_문서 --output 5학년부_2025.db

2. 생성된 인덱스 파일을 업무 메신저로 공유
   └─> "5학년부_2025.db" (약 50MB)

[팀원]
3. 인덱스 파일 다운로드 후 지정 위치에 저장
   └─> ./chroma/5학년부_2025.db

4. 검색 실행
   └─> rag_local.exe query "수련활동 준비물" --index 5학년부_2025.db

5. 업무 종료 후 삭제
   └─> 파일 하나만 삭제하면 끝
```

#### 보안 고려사항
- 인덱스 파일에는 **원본 텍스트 내용이 포함**되므로, 민감한 문서는 별도 관리
- 공유 범위: 해당 부서 팀원으로 한정
- 파일명에 버전/날짜 포함으로 관리 용이

---

## 7. 배포 구조

### 7.1 개인 교사용
```
rag_local.exe              # 단일 실행 파일
├─ 내장 모델 (옵션)
└─ config.yaml             # 설정 파일
```

### 7.2 부서 공유용 - 인덱스 파일 중심 운영

#### 담당자 (인덱스 생성자)
```
rag_local.exe
├─ config.yaml
└─ 원본 문서 폴더
    └─> 인덱싱 → 5학년부_2025_09.db 생성
```

#### 팀원 (인덱스 사용자)
```
rag_local.exe              # 실행 파일
├─ chroma/                 # 인덱스 저장 폴더
│   ├─ 5학년부_2025_09.db      # 메신저로 받은 파일
│   └─ 교무부_공지사항.db      # 다른 부서 인덱스
└─ config.yaml
```

**핵심**: 원본 문서 없이 인덱스 파일만으로 검색 가능

### 7.3 CLI 명령어 예시

#### 개인 모드 (기본)
```bash
# 문서 폴더 인덱싱 (기본 DB 사용)
rag_local.exe index --folder ./내문서

# 검색
rag_local.exe query "체육대회 준비물"

# 인덱스 삭제
rag_local.exe clean
```

#### 부서 모드 (인덱스 파일 지정)
```bash
# 담당자: 특정 이름으로 인덱스 생성
rag_local.exe index --folder ./5학년_문서 --output 5학년부_2025_09

# 팀원: 받은 인덱스 파일로 검색
rag_local.exe query "수련활동 일정" --index 5학년부_2025_09

# 여러 인덱스 동시 검색
rag_local.exe query "학부모 안내문" --index 5학년부_2025_09,교무부_공지

# 인덱스 목록 확인
rag_local.exe list

# 특정 인덱스만 삭제
rag_local.exe clean --index 5학년부_2025_09
```

---

## 8. 확장 가능성

### 8.1 단계별 확장 로드맵

#### Phase 1: CLI (현재)
- 기본 검색/인덱싱 기능
- 로컬 Vector DB

#### Phase 2: GUI (Tkinter)
- 간단한 데스크톱 UI
- 검색창 + 결과 표시

#### Phase 3: WebUI (FastAPI)
- 학년부/교무부 공동 활용
- 웹 브라우저 접근
- 동시 다중 사용자 지원

#### Phase 4: LLM 연동
- 로컬 LLM (llama.cpp) 또는 OpenAI API
- 생성형 답변 (요약, 초안 작성)
- 문맥 기반 대화형 Q&A

### 8.2 확장 설계 고려사항

```
┌─────────────────────────────────────┐
│         Frontend Options             │
│  ┌────────┐  ┌────────┐  ┌────────┐ │
│  │  CLI   │  │ Tkinter│  │FastAPI │ │
│  │        │  │  GUI   │  │ WebUI  │ │
│  └────────┘  └────────┘  └────────┘ │
└──────────────┬──────────────────────┘
               │
               ↓
┌─────────────────────────────────────┐
│        Core RAG Engine               │
│    (공통 API - 재사용 가능)          │
│  - query(text) → results             │
│  - index(folder) → status            │
│  - manage(action) → response         │
└──────────────┬──────────────────────┘
               │
               ↓
┌─────────────────────────────────────┐
│      Backend Options                 │
│  ┌────────┐  ┌────────┐  ┌────────┐ │
│  │ChromaDB│  │ 로컬   │  │ LLM    │ │
│  │        │  │ LLM    │  │ API    │ │
│  └────────┘  └────────┘  └────────┘ │
└─────────────────────────────────────┘
```

---

## 9. 성능 고려사항

### 9.1 최적화 전략
- **임베딩**: 배치 처리 (32-64 문서 동시 처리)
- **검색**: 인덱스 캐싱으로 응답 시간 < 1초
- **파싱**: 대용량 PDF는 병렬 페이지 처리

### 9.2 제약사항
- **메모리**: 임베딩 모델 약 400MB RAM 사용
- **디스크**: 1,000개 문서당 약 100MB 벡터 DB
- **CPU**: 임베딩 생성 시 다중 코어 활용

---

## 10. 프로젝트 구조 (예상)

```
jobqa/
├── src/
│   ├── core/
│   │   ├── embedder.py          # 임베딩 엔진
│   │   ├── parser.py             # 문서 파서
│   │   └── vector_search.py      # 벡터 검색
│   ├── services/
│   │   ├── indexing.py           # 인덱싱 서비스
│   │   ├── query.py              # 쿼리 핸들러
│   │   └── management.py         # 관리 서비스
│   ├── cli/
│   │   └── main.py               # CLI 엔트리포인트
│   └── utils/
│       ├── config.py             # 설정 관리
│       └── logger.py             # 로깅
├── tests/
│   ├── test_parser.py
│   ├── test_embedder.py
│   └── test_search.py
├── docs/
│   ├── 기획문서.txt
│   └── 아키텍처.md
├── requirements.txt
├── setup.py
└── README.md
```

## 12. 라이선스 및 배포

- **라이선스**: Apache-2.0 (오픈소스)
- **배포 대상**: 교육 기관 (학교, 교육청) / 공공 기관
- **지원 방식**: GitHub 이슈 트래커, 사용 가이드 문서

